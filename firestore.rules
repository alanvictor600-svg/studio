rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isSeller() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'vendedor';
    }
    
    function isClient() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'cliente';
    }

    // Rules for 'users' collection
    match /users/{userId} {
      allow read: if (isAdmin() || isOwner(userId));
      allow create: if !isSignedIn(); // Allow user creation during sign-up before they are authenticated
      allow update: if isOwner(userId) || isAdmin(); // Admins can update any user, users can update their own doc
      allow delete: if isAdmin(); // Only admins can delete users
    }
    
    // Rules for 'tickets' collection
    match /tickets/{ticketId} {
      allow read: if (isAdmin() || (isSignedIn() && (resource.data.buyerId == request.auth.uid || resource.data.sellerId == request.auth.uid)));
      allow create: if isSignedIn(); // Any authenticated user can create a ticket
      allow update, delete: if isAdmin(); // Only admins can modify or delete tickets
    }

    // Rules for 'draws' collection
    match /draws/{drawId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    // Rules for 'configs' collection
    match /configs/{configId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    // Rules for 'sellerHistory' collection
    match /sellerHistory/{historyId} {
      // Sellers can read their own history, Admins can read all.
      allow read: if (isAdmin() || (isSeller() && resource.data.sellerId == request.auth.uid));
      allow create, update, delete: if isAdmin(); // Only Admins can create history (done via batch job)
    }

    // Rules for 'adminHistory' collection
    match /adminHistory/{historyId} {
      allow read, create, update, delete: if isAdmin(); // Only admins can manage this collection
    }
  }
}